PQ-NAS / DNA QR-Auth v4
Encoding & Canonicalization (FINAL)

This document freezes all encoding choices for QR-Auth v4 as used by PQ-NAS.
All implementations MUST follow these rules exactly.

1Ô∏è‚É£ Base Encoding Rules (Global)
Base64 Variant

Base64url (RFC 4648 ¬ß5)

Rules:

Alphabet: A‚ÄìZ a‚Äìz 0‚Äì9 - _

NO padding (= is forbidden)

UTF-8 input

Output is ASCII

This applies to:

hashes

signatures

public keys

tokens

binary payloads

üëâ Never use hex anywhere in v42Ô

∏è‚É£ Canonical JSON (MANDATORY)

All JSON that is signed or hashed MUST be canonicalized using:

‚úÖ RFC 8785 ‚Äì JSON Canonicalization Scheme (JCS)

Rules summary:

UTF-8

Object keys sorted lexicographically

No insignificant whitespace

Numbers serialized minimally

Strings escaped per JSON spec

Arrays preserve order

If JCS is unavailable, a strict JCS-compatible subset must be implemented.
Do not invent your own relaxed format.
3Ô∏è‚É£ Token Structure (Common)

All tokens use the same structure:

<BASE64URL(canonical_json_payload)>.<BASE64URL(signature)>


No headers.
No padding.
No additional delimiters.

4Ô∏è‚É£ Request Token (req_token)
Purpose

Proves QR was generated by PQ-NAS

Enables stateless verification

Short-lived (‚âà60‚Äì120s)

Payload (JSON, canonicalized)
{
  "v": 4,
  "typ": "req",
  "iss": "pq-nas",
  "aud": "dna-messenger",
  "origin": "https://nas.example.com",
  "sid": "Tr85XMc-udOkg4D-CTOKuw4-0brHQX_U",
  "chal": "<base64url(random_32_bytes)>",
  "iat": 1768620000,
  "exp": 1768620060,
  "scope": "pqnas.login",
  "nonce": "<base64url(random_16_bytes)>"
}

Server Signature

Input: SHA256(canonical_json_payload_bytes)

Algorithm (v0): Ed25519

Signature encoding: base64url

Final Encoding
req_token = base64url(payload_bytes) + "." + base64url(server_signature)

5Ô∏è‚É£ Approval Proof (proof_token)
Purpose

Proves user approval

Proves DNA identity

Binds approval to exact req_token

Fully stateless

Proof Payload (JSON, canonicalized)
{
  "v": 4,
  "typ": "proof",
  "req": "<req_token>",
  "fingerprint": "<base64url(sha3-512(pubkey))>",
  "pk": "<base64url(public_key_bytes)>",
  "pk_alg": "ML-DSA-87",
  "ts": 1768620005,
  "device": {
    "app": "dna-messenger",
    "ver": "0.99.105",
    "platform": "android"
  }
}

6Ô∏è‚É£ What the Phone Signs (CRITICAL)
Step 1: Hash the request token
req_hash = SHA256(UTF8(req_token_string))
req_hash_b64 = BASE64URL(req_hash)

Step 2: Build signing message (UTF-8 text)
DNAQR-V4
<req_hash_b64>
<fingerprint_b64>
<ts_decimal>


Line breaks are literal \n (0x0A)
No trailing newline.

Example (visual):

DNAQR-V4
m9mYcE3Vv0Z8Zb9b5Z8M2aJ4H6QbP2zEw4C8k9p6x9k
L0DkM3F0Bv7H4RZP2yE5g8S6CwqZ8bV4Xv9x5m7J0kY
1768620005

Step 3: Signature

Prehash: SHA3-512(message_bytes)

Signature algorithm: DNA identity key (ML-DSA / Dilithium class)

Output encoding: base64url

Step 4: Proof token encoding
proof_token =
  base64url(canonical_json(proof_payload_without_sig))
  + "."
  + base64url(phone_signature)

7Ô∏è‚É£ Verification (Stateless)

Verifier MUST:

Split proof_token

Canonicalize + verify phone signature

Extract req_token

Verify server signature on req_token

Check exp, iat, origin, scope

Recompute req_hash_b64

Rebuild signing message exactly

Verify fingerprint ‚Üî public key binding:

fingerprint == base64url(SHA3-512(pk_bytes))


Validate timestamp window (¬±60s)

Issue browser session

No database required.

8Ô∏è‚É£ Encoding Summary (DO NOT DEVIATE)
Item	Encoding
Hashes	base64url
Public keys	base64url
Signatures	base64url
Tokens	payload_b64.sig_b64
JSON	RFC 8785 JCS
Binary ‚Üí text	UTF-8
Padding	FORBIDDEN

9Ô∏è‚É£ Rationale (Why base64url everywhere)

Matches DNA-auth

Avoids hex/binary confusion

QR-friendly

URL-safe

Smaller payloads

Easier Dart ‚Üî C ‚Üî Rust interop

10Ô∏è‚É£ Compatibility

This spec is compatible with:

PQ-NAS

DNA-Messenger

QR-Auth v4

Stateless CDN verification

Device-to-device auth

Offline verification (future)

Status

LOCKED FOR V4

Any change requires v5.
